<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">
<title>WIFIRE Live Weather</title>
<link rel="stylesheet" href="lib/style.css" />
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js" type="text/javascript"></script>
<script src="lib/LetterIcon.js" type="text/javascript"></script>
<script src="lib/L.Symbol.js" type="text/javascript"></script>
<script src="lib/leaflet.polylineDecorator.min.js" type="text/javascript"></script>
</head>
<body>

 <input onchange="checkLayer()" type="checkbox" name="menu" id="wind" value="1" checked>wind
 <input onchange="checkLayer()" type="checkbox" name="menu" id="temperature" value="2" checked>temperature
 <input onchange="checkLayer()" type="checkbox" name="menu" id="humidity" value="5" checked>humidity
 <br>
 <div id="map" style="width: 1200px; height: 600px; border: 1px solid #ccc"></div>
 <script type="text/javascript">
        
     var showWind = true;
     var showTemp = true;
     var showHumid = true;
    
     var stations = {};
         
     checkLayer();
     
     // markers sizes
     var CIRCLE_R = 12000;
     var ARROW_R = 0.12;
     var CIRCLE_T = 0.5;
     var ARROW_SIZE = 10;
     var center = [ 32.980865, -117.034080 ];
    
     // init map
     var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
         osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors', osm = L
         .tileLayer(osmUrl, {
             maxZoom : 17,
             attribution : osmAttrib
         });
     var map = new L.Map('map', {
         layers : [ osm ],
         center : new L.LatLng(center[0], center[1]),
         zoom : 9
     });

     var webSocket = new WebSocket(
            "ws://florian.sdsc.edu:9090/livewx/websocket");
                
     webSocket.onopen = function(message) {
         processOpen(message);
     };
     
     webSocket.onclose = function(message) {
         processClose(message);
     };
     webSocket.onerror = function(message) {
         processError(message);
     };
 
     get_humidity_color = function(ua) {
         if (ua == "")
             return '#FFFFFF';
         if (ua <= 10) {
             return '#ff0000';
         } else if (ua <= 20) {
             return '#ff9966';
         } else if (ua <= 30) {
             return '#ffcc99';
         } else if (ua <= 40) {
             return '#ccffff';
         } else if (ua <= 50) {
             return '#99ccff';
         } else if (ua <= 60) {
             return '#6699ff';
         } else if (ua <= 70) {
             return '#3366ff';
         } else if (ua <= 80) {
             return '#3333ff';
         } else if (ua <= 90) {
             return '#0000cc';
         } else {
             return '#000066';
         }
     }
     
     select_th_color = function(th) {
         if (th == "")
             return "#FFFFFF";
         if (th < -10) {
             return "#000066"
         } else if (th < -7) {
             return "#333399"
         } else if (th < -4) {
             return "#66FFFF"
         } else if (th < -1) {
             return "#3333CC"
         } else if (th < 2) {
             return "#3366FF"
         } else if (th < 5) {
             return "#6699FF"
         } else if (th < 8) {
             return "#99CCFF"
         } else if (th < 11) {
             return "#99CCFF"
         } else if (th < 14) {
             return "#EAF5FF"
         } else if (th < 17) {
             return "#FFEBEB"
         } else if (th < 20) {
             return "#FFE6CC"
         } else if (th < 23) {
             return "#FF9966"
         } else if (th < 26) {
             return "#FFCC99"
         } else if (th < 29) {
             return "#FFAD85"
         } else if (th < 32) {
             return "#FF9966"
         } else if (th < 35) {
             return "#FF9933"
         } else if (th < 38) {
             return "#FF6600"
         } else if (th < 41) {
             return "#FF3300"
         } else if (th < 44) {
             return "#FF0000"
         } else {
             return "#CC0000"
         }
     };
     
     get_wind_speed = function(sm) {
         var speed = 100 - sm * 15;
         if (speed > 0) {
             return speed;
         } else {
             return 1;
         }
     }
     
     info_output = function(jsonData) {
 
         return ("<table>" + "<tr>" + "<th>Wind Average Speed(SM)</th>"
                 + "<th>Wind Average Direction(DM)</th>"
                 + "<th>Air Temperature(TA)</th>"
                 + "<th>Relative Humidity(UA)</th>" + "</tr>" + "<tr>"
                 + "<td>" + jsonData.message.Sm + "</td>" + "<td>"
                 + jsonData.message.Dm + "</td>" + "<td>"
                 + jsonData.message.Ta + "</td>" + "<td>"
                 + jsonData.message.Ua + "</td>" + "</tr>" + "</table>");
     }
     
     show_data_in_popup = function(station, jsonData) {
         
         //var popup = station.getPopup();
         //if (popup != null) {
             //if (popup._isOpen) {
                 //station.closePopup();
                 //station.bindPopup(info_output(jsonData));
                 //station.openPopup();
             //} else {
                 //station.bindPopup(info_output(jsonData));
             //}
         //}
     }
     
     get_wind_cord = function(origin, r, degree) {
         var d = parseFloat(degree) + 180;
         return new L.LatLng(r * Math.cos(d * Math.PI / 180) + origin.lat,
                 r * Math.sin(d * Math.PI / 180) + origin.lng);
     }
 
     webSocket.onmessage = function processMessage(message) {
         
         var jsonData = JSON.parse(message.data);
         if (jsonData.message != null) {
 
             var message = jsonData.message;
             var code = message.Name;
             var station = stations[code];

             if(parseFloat(message.lat) == 1) {
                 stations[code] = { lat : -1 };
                 return;
             }

             if(station != null && station.lat == -1) {
                 return;
             }
             
             if(station == null) {
             
                 station = {};
                 
                 station.latlng = new L.LatLng(parseFloat(message.lat),
                         parseFloat(message.lng));
                 station.name = message.Name;
                 
                 console.log("new station " + station.name + " at " +
                         station.latlng.lat + " " + station.latlng.lng);

                 station.humidCircle = null;
                 station.tempCircle = null;
                 station.Arrow = null;
                 station.arrowHead = null;
                 
                 station.label = L.marker(station.latlng,
                     {icon : new L.divIcon(
                         {iconAnchor : new L.Point(station.latlng),
                         iconSize: [0, 0],
                         html : station.name
                     })
                 })
                 .addTo(map);
                 
                 stations[code] = station;
                 
             }
                    
             //show_data_in_popup(station.humidCircle, jsonData);
             
             if (jsonData.message.hasOwnProperty('Ta') && showTemp) {                 
                 var ta = jsonData.message.Ta.split(".");
                 var color = select_th_color(ta[0]);
                 if(station.tempCircle == null) {
                     station.tempCircle = L.circle(station.latlng, CIRCLE_R, {
                         color : '#000',
                         weight : 1,
                         opacity : 1,
                         fillColor : color,
                         fillOpacity : CIRCLE_T
                         }).addTo(map).bringToBack();                         
                 } else {
                     station.tempCircle.setStyle({fillColor : color});   
                 }
             }
             
             if (jsonData.message.hasOwnProperty('Ua')) {
                 
                 var opened = false;
                 //if (PA.getPopup() != null) {
                     //opened = PA.getPopup()._isOpen;
                 //}
                 
                 if(showHumid) {
                     var ua = jsonData.message.Ua.split("P");
                     var color = get_humidity_color(parseFloat(ua[0]));
                     if(station.humidCircle == null) {
                         station.humidCircle = new L.circleMarker(station.latlng, {
                             radius : 20,
                             color : '#000',
                             weight : 1,
                             opacity : 1,
                             fillColor : color,
                             fillOpacity : 1
                             })
                            .bindPopup(info_output(jsonData))
                            .addTo(map)
                            .bringToFront();
                         
                         if(station.Arrow != null) {
                             station.Arrow.bringToFront();
                         }
                         
                     } else {
                         station.humidCircle.setStyle({fillColor : color});                         
                     }
                 }
                 
                 //if (opened) {
                     //station.humidCircle.openPopup();
                 //}
             }
             
             if (showWind && jsonData.message.hasOwnProperty('Dm')
                 && jsonData.message.hasOwnProperty('Sm')) {
                     
                 var dm = parseFloat(jsonData.message.Dm.split("D")[0]);
                 var sm = parseFloat(jsonData.message.Sm.split("D")[0]);
                 
                 var latlngs = [station.latlng,
                                get_wind_cord(station.latlng, sm * ARROW_R / 5, dm)];
                 
                 if (station.Arrow == null) {
                     station.Arrow = L.polyline(latlngs,
                         {color : '#000',
                         weight : 1,
                         opacity : 1,
                         }).addTo(map)
                         .bringToFront();                            
                     station.arrowHead = L.polylineDecorator(station.Arrow)
                         .addTo(map);
                     station.arrowHead.setPatterns([ {
                         offset : 100 + '%',
                         repeat : 0,
                         symbol : L.Symbol.arrowHead({
                             pixelSize : ARROW_SIZE,
                             polygon : false,
                             pathOptions : {stroke : true,
                                 color : '#000',
                                 weight : 1,
                                 opacity : 1}
                         })
                     } ]);
                 } else {
                     station.Arrow.setLatLngs(latlngs);
                     station.arrowHead.setPaths(station.Arrow);
                 }
             }
         }
     }
     
     function IsNumeric(n) {
         return !isNaN(parseFloat(n)) && isFinite(n);
     }
     
     function processOpen(message) {
         //messagesTextArea.value += "server connect..." + "\n";
         webSocket.send('start');
     }
     
     function processClose(message) {
         //webSocket.send('stop');
         //messagesTextArea.value += "Sever Disconnect..." + "\n";
     }
     
     function processError(message) {
         //messagesTextArea.value += "Error..." + "\n";
     }
     
     function checkLayer() {
         
         showWind = document.getElementById("wind").checked;
         showTemp = document.getElementById("temperature").checked;
         showHumid = document.getElementById("humidity").checked;

         for(var name in stations) {
             
             var station = stations[name];
             
             if (!showWind) {
                 if (station.Arrow != null && station.arrowHead != null) {
                     window.map.removeLayer(station.Arrow);
                     window.map.removeLayer(station.arrowHead);
                 }
             }
             
             if (!showTemp) {
                 if (station.tempCircle != null)
                     window.map.removeLayer(station.tempCircle);
             }
                 
             if (!showHumid) {
                 if(stations.humidCircle != null) {            
                     window.map.removeLayer(station.humidCircle);
                     station.humidCircle = new L.circleMarker(station.latlng, {
                         radius : 20,
                       }).bindLabel(station.name, {className : 'station-label', 
                           offset : [-10,-10],
                           noHide : true}).
                       addTo(map).
                       showLabel();
                 }
            }
        } 
    }
    
    </script>
</body>
</html>
